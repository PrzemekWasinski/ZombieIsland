<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zombie Island</title>
    <link rel="stylesheet" type="text/css" href="/styles.css" />
</head>
<body>
    <div id="authSection" class="container">
        <div id="loginForm">
            <h2>Login</h2>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="Password">
            <div id="loginError" class="error"></div>
            <button onclick="login()">Login</button>
            <p class="link" onclick="showForgotPassword()">Forgot Password?</p>
            <p>Don't have an account? <a href="#" onclick="showRegister()">Register</a></p>
        </div>

        <div id="registerForm" style="display:none;">
            <h2>Register</h2>
            <input type="text" id="username" placeholder="Username">
            <input type="email" id="registerEmail" placeholder="Email">
            <input type="password" id="registerPassword" placeholder="Password">
            <input type="password" id="confirmPassword" placeholder="Confirm Password">
            <select id="characterClass">
                <option value="">Select Character Class</option>
                <option value="summoner">Summoner</option>
                <option value="mage">Mage</option>
                <option value="melee">Melee</option>
                <option value="ranger">Ranger</option>
                <option value="herbologist">Herbologist</option>
            </select>
            <div id="registerError" class="error"></div>
            <button onclick="register()">Register</button>
            <p>Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
        </div>

        <div id="forgotPasswordForm">
            <h2>Reset Password</h2>
            <input type="email" id="forgotEmail" placeholder="Enter your email">
            <div id="forgotPasswordError" class="error"></div>
            <div id="forgotPasswordSuccess" class="success"></div>
            <button onclick="resetPassword()">Send Reset Link</button>
            <p class="link" onclick="showLogin()">Back to Login</p>
        </div>
    </div>

    <div id="gameSection">
        <canvas height="615" width="1093" id="game-canvas"></canvas>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script type="module" src="/Game/game.js"></script>

    <script>
        //Firebase config is usually here but only I get to see it

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        function clearMessages() {
            document.getElementById('loginError').textContent = '';
            document.getElementById('forgotPasswordError').textContent = '';
            document.getElementById('forgotPasswordSuccess').textContent = '';
        }

        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'none';
            clearMessages()
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('forgotPasswordForm').style.display = 'none';
            clearMessages()
        }

        function showForgotPassword() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'block';
            clearMessages()
        }

        async function resetPassword() {
            const email = document.getElementById('forgotEmail').value;
            const forgotPasswordError = document.getElementById('forgotPasswordError');
            const forgotPasswordSuccess = document.getElementById('forgotPasswordSuccess');

            forgotPasswordError.textContent = '';
            forgotPasswordSuccess.textContent = '';

            if (!email) {
                forgotPasswordError.textContent = 'Please enter your email';
                return;
            }

            try {
                await auth.sendPasswordResetEmail(email);
                
                forgotPasswordSuccess.textContent = 'Password reset link sent to your email. Check your inbox.';
                
                document.getElementById('forgotEmail').value = '';
            } catch (error) {
                forgotPasswordError.textContent = error.message;
                console.error('Password reset error:', error);
            }
        }

        async function register() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const characterClass = document.getElementById('characterClass').value;
            const registerError = document.getElementById('registerError');

            if (!username || !email || !password || !confirmPassword || !characterClass) {
                registerError.textContent = 'Please fill in all fields';
                return;
            }

            if (password !== confirmPassword) {
                registerError.textContent = 'Passwords do not match';
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                const userData = {
                    username: username,
                    email: email,
                    characterClass: characterClass,
                    gold: 100,
                    inventory: [],
                    level: 1
                };

                await database.ref('users/' + user.uid).set(userData);

                alert('Registration successful!');
                showLogin();
            } catch (error) {
                registerError.textContent = error.message;
                console.error('Registration error:', error);
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginError = document.getElementById('loginError');

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                const userSnapshot = await database.ref('users/' + user.uid).once('value');
                const userData = userSnapshot.val();

                if (!userData) {
                    throw new Error('User data not found');
                }

                document.getElementById('authSection').style.display = 'none';
                document.getElementById('gameSection').style.display = 'block';

                document.getElementById('gameUsername').textContent = userData.username;
                document.getElementById('gameClass').textContent = userData.characterClass;
                document.getElementById('gameGold').textContent = userData.gold;

            } catch (error) {
                loginError.textContent = error.message;
                console.error('Login error:', error);
            }
        }

        function logout() {
            auth.signOut().then(() => {
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('gameSection').style.display = 'none';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                showLogin();
            }).catch((error) => {
                console.error('Logout error:', error);
            });
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                database.ref('users/' + user.uid).once('value').then((snapshot) => {
                    const userData = snapshot.val();
                    
                    if (userData) {
                        document.getElementById('authSection').style.display = 'none';
                        document.getElementById('gameSection').style.display = 'block';

                        document.getElementById('gameUsername').textContent = userData.username;
                        document.getElementById('gameClass').textContent = userData.characterClass;
                        document.getElementById('gameGold').textContent = userData.gold;
                    } else {
                        console.error('No user data found');
                        auth.signOut();
                    }
                }).catch((error) => {
                    console.error('Error fetching user data:', error);
                });
            } else {
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('gameSection').style.display = 'none';
                showLogin();
            }
        });
    </script>
</body>
</html>